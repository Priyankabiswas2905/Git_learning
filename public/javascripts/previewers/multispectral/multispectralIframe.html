<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<title>Insert title here</title>
<style type="text/css">
    body{
		height: 100%;
		width: 100%;
		padding: 0;
		margin: 0;
		background: none;
    }
    div#viewer{
		width: 100%;
		height: 100%;
		left: 0%;
		right: 0px;
		position: absolute;
    }
    div#spectra{
    	background: none repeat scroll  #000000;
    	height:100%;
    	width:100%;
    	left: 0%;
    	position: absolute;
    	overflow:visible;

    }
    h2, h3{
    	text-align: center;
    	color: #BBB;
    	font-family: verdana,sans-serif;
    }
    
    h2{
		font-size: 12pt;
		margin-top: 0.3em;
    }
    h3 {
	    margin-top: -1em;
	    margin-bottom: 1.5em;
	    font-size: 7pt;
	}
	img#loading {
	    position: absolute;
	    visibility: hidden;
	}
	#spectra span {
	    position: absolute;
	    font-size: 8pt;
	    text-align: center;
	    color: #BBB;
	}
	#wavelengthspan{
		position:absolute;
		left:40%;
		font-size:10pt !important;
	    color: #BBB;
	}
  </style>
</head>
<body style="background:none;color:white;">

<script type="text/javascript">

var spectrum;
var uploadDirsServer;
var graphArray;

function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}

function clickTarget( e ){ 

    if( !e.target.src ){
	spectrum.drawGrid();
	return;
    }
    
    $('loading').fade('in');

    var tilesrc = e.target.src;

    var xx, yy;
    if( e.event.layerX ) xx = e.event.layerX; // Only Firefox seems to support this
    else if( e.event.offsetX ) xx = e.event.offsetX;  // for Opera
    else xx = e.event.clientX - e.target.offsetLeft;  // For IE

    if( e.event.layerY ) yy = e.event.layerY;
    else if( e.event.offsetY ) yy = e.event.offsetY;
    else yy = e.event.clientY - e.target.offsetTop;

    var jtl = tilesrc.substring(tilesrc.search('JTL=')+4);
    
    var data = Array();
    for(i = 0; i < graphArray.length; i++){
    	new Request({
    		method: 'get',
    		async: false,
    		    url: this.server + "?FIF=" + graphArray[i][0] + "&spectra="+jtl+','+xx+','+yy,
    		    onSuccess: function(responseText, responseXML)
    		    {
	    			var w = graphArray[i][1];
	    			var r = parseFloat(responseXML.getElementsByTagName('reflectance')[0].childNodes[0].nodeValue);
	    			data[i] = [w,r];     
    		    }
    		}).send()  ; 
    }

    $('loading').fade('out');
    spectrum.plot(data);

  };
  
	function prepareSpectre(){
		  var prNum = window.frameElement.id.replace("multispectralIframe","");
			var uploadDirsArrays = window.frameElement.contentWindow.parent.window["currentMultispectral" + prNum];
			uploadDirsServer = window.frameElement.contentWindow.parent.window["multispectralServer" + prNum];

			var firstImage;

			var uploadDirsArray = uploadDirsArrays.join(",").split(",");
			graphArray = new Array();
			var graphArrayCounter = 0;
			var maxWavelength = 0;
			var minWavelength = 1000000;
			var finalArray = new Array();
			var finalArrayCounter = 0;
			
			for(var i = 0; i < uploadDirsArray.length; i = i+2){
				//Add wavelength reflectance files references to the array of data to be graphed
				if(uploadDirsArray[i+1].indexOf("wavelength ") == 0){
					graphArray[graphArrayCounter] = new Array();
					graphArray[graphArrayCounter][0] = uploadDirsArray[i];
					var currWavelength = parseInt(uploadDirsArray[i+1].substring(11),10);
					graphArray[graphArrayCounter][1] = currWavelength;
					graphArrayCounter++;
					
					if(currWavelength < minWavelength)
						minWavelength = currWavelength;
					else if(currWavelength > maxWavelength)
						maxWavelength = currWavelength;
				}
				//Add the rest of the images to the image blender
				else{
					if(finalArrayCounter == 0)
						firstImage = uploadDirsArray[i];
					
					finalArray[finalArrayCounter] = new Array();
					finalArray[finalArrayCounter][0] = uploadDirsArray[i];
					finalArray[finalArrayCounter][1] = uploadDirsArray[i+1];
					finalArrayCounter++;
				}
			}

			//Do nothing if no visible images, print out error message.
			if(finalArrayCounter == 0){
				document.getElementById("spectra").setAttribute("style","display:none;");				
				var errorMsg = document.createElement('p');
				errorMsg.innerHTML = "No visible images to display.";
				errorMsg.setAttribute("style","color:black;");
				document.getElementById("viewer").appendChild(errorMsg);
				
				window.frameElement.setAttribute("style","height:550px;");
				
				return;
			}

			iipmooviewer = new IIPMooViewer( "viewer", {
				image: firstImage,
				server: uploadDirsServer,
				click: clickTarget
			      });

			if(finalArrayCounter > 1)
				iipmooviewer.blend(finalArray);

			//Must have at least two different spectral reflectance images to have a meaning to draw a graph
			if(graphArrayCounter >= 2){
				// Create our spectral graph object
			    spectrum = new Spectrum('spectra', minWavelength, maxWavelength, graphArray);
			}
		  
		  
	  }

window.onload=function(){
	//Use a small, undetectable timeout when in Firefox, as to avoid some race condition stopping the spectre graph from showing up correctly
	if(navigator.userAgent.toLowerCase().indexOf("mozilla") >= 0)
		setTimeout(function(){
			prepareSpectre();
		},65);
	else
		prepareSpectre();
	
};

var s = document.createElement("link");
s.type = "text/css";
s.href =  decodeURIComponent(getUrlVars()["pathCss"].substring(getUrlVars()["pathCss"].lastIndexOf("http%3A")))   + "iip2.css";
s.media = "all";
s.rel = "stylesheet";
document.getElementsByTagName("head")[0].appendChild(s);

s = document.createElement("link");
s.type = "text/css";
s.href =  decodeURIComponent(getUrlVars()["pathCss"].substring(getUrlVars()["pathCss"].lastIndexOf("http%3A")))   + "blending.css";
s.media = "all";
s.rel = "stylesheet";
document.getElementsByTagName("head")[0].appendChild(s);

s = document.createElement("link");
s.href = decodeURIComponent(getUrlVars()["pathImages"].substring(getUrlVars()["pathImages"].lastIndexOf("http%3A"))) + "iip-favicon.png";
s.rel = "shortcut icon";
document.getElementsByTagName("head")[0].appendChild(s);

var pathJs = decodeURIComponent(getUrlVars()["pathJs"].substring(getUrlVars()["pathJs"].lastIndexOf("http%3A")))  ;

// s = document.createElement("script");
// s.type = "text/javascript";
// s.src = pathJs + "protocols.js";
// s.async = false;
// s.defer = false;
// document.getElementsByTagName("head")[0].appendChild(s);

s = document.createElement("script");
s.type = "text/javascript";
s.src = pathJs + "mootools-yui-compressed.js";
s.async = false;
s.defer = false;
document.getElementsByTagName("head")[0].appendChild(s);

s = document.createElement("script");
s.type = "text/javascript";
s.src = pathJs + "iipmooviewer-2.0-compressed.js";
s.async = false;
s.defer = false;
document.getElementsByTagName("head")[0].appendChild(s);

s = document.createElement("script");
s.type = "text/javascript";
s.src = pathJs + "moocanvas-compressed.js";
s.async = false;
s.defer = false;
document.getElementsByTagName("head")[0].appendChild(s);

s = document.createElement("script");
s.type = "text/javascript";
s.src = pathJs + "spectrum.js";
s.async = false;
s.defer = false;
document.getElementsByTagName("head")[0].appendChild(s);

</script>
<div style="height:50%;top:50%;" id="spectra"></div>
<div style="height:50%;" id="viewer"></div>

</body>
</html>