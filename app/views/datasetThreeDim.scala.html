@(dataset: models.Dataset, comments: List[Comment], previews : Map[models.File, Array[(java.lang.String, String, String, String, java.lang.String, String, Long)]], md: Map[String,Any], usrmd: scala.collection.mutable.Map[String,Any], beingProcessed: Boolean, collectionsOutside: List[models.Collection], collectionsInside: List[models.Collection], filesOutside: List[models.File])(implicit user: Option[securesocial.core.Identity]) 


@import helper._
@import collection.JavaConverters._
@import com.mongodb.casbah.Imports.DBObject
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

@main("Dataset 3D") {
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
    <script>
    	var isPageLoaded = false;
    	var isx3dActive = false;
    	var Configuration = {};
    	Configuration.id  = "@dataset.id";
		Configuration.authenticated = @user.isDefined;
		Configuration.hostIp = "@play.Play.application().configuration().getString("hostIp")";
		Configuration.ptmAppletPath = "@(routes.Assets.at("plugins") + "/" + "envlib.jar")";
		Configuration.expressInstallPath = "@(routes.Assets.at("plugins") + "/" + "expressInstall.swf")";
		Configuration.iipZoomPath = "@(routes.Assets.at("plugins") + "/" + "IIPZoom.swf")";
		Configuration.jsPath = "@(routes.Assets.at("javascripts"))";
		Configuration.imagesPath = "@(routes.Assets.at("images"))";
		Configuration.calledFrom = "3d_dataset";
		Configuration.fileUrl = new Array();
		Configuration.url = "";
		Configuration.tab = "#previewer_@dataset.id";
		Configuration.previewer = "/assets/javascripts/previewers/x3dom";
		Configuration.wasPTM = false;
		var previewName = "";
    </script>
    <script>
    	window.onload = function() {
    		isPageLoaded = true;
    	}
    </script>
    
	<div class="page-header">
		<h1>@dataset.name</h1>
	</div>
	
	<div class="row">	
		<div class="col-md-8" id="filePrevsCol">
			@if(dataset.files.length == 2) {
				@for((f, pvs) <- previews) {
					@for(i <- pvs.indices) {
						@if(pvs(i)._2 == "X3d"){
							@println("X3d preview found")
							<script> Configuration.fileUrl.push("@pvs(i)._5");
								previewName = "@pvs(i)._2";
							</script>
						}
					}
				}
			}
		
		<div id='previewedFileName_@(dataset.id.toString)' class='filenameDiv'></div>
			
				<div class="row" id="filePrevContainer_@(dataset.id.toString)" data-previewsCount="1" >
					<div class="span12">
				  		<div class="tabbable">
							<ul class="nav nav-pills" id="myTab_@(dataset.id.toString)">
						    		<li class=""><a href="#previewer_@(dataset.id.toString)" data-toggle="tab">X3d</a></li>
							</ul>
							<div class="tab-content" id="previewsContent_@(dataset.id.toString)">
						  		<div class="tab-pane previewDiv" id="previewer_@(dataset.id.toString)"></div>
						  		<script type="text/javascript" src="/assets/javascripts/previewers/x3dom/some-library.js"></script>
						  		<script type="text/javascript">
									$(function () {
					    				$('#myTab_@(dataset.id.toString) a:first').tab('show');
					    				$('#myTab_@(dataset.id.toString)').attr('style', 'display:none;');
					 				 })
								</script>						  							  								  		
							</div>
						</div>					
		  			</div>
				</div>
				
				@if(beingProcessed == true){
    			<div id='beingProcessed' style='display:block;'><h5>Dataset is being processed...</h5></div>  		
	    		}else{
	    			<div id='beingProcessed' style='display:none;'><h5>Dataset is being processed...</h5></div> 
	    		}
	    		<!--<script>
	    			function updateIsBeingProcessed(){
	    				var request = $.ajax({
	 				       type: 'GET',  
	 				       url: "@api.routes.Datasets.isBeingProcessed(dataset.id.toString)",
	 				       contentType: "application/json"
	 				     });
	    				request.done(function (respJSON){
							if(respJSON.isBeingProcessed == "true")
								$("#beingProcessed").css('display','block');
							else
								$("#beingProcessed").css('display','none');
		     			});				 
					  request.fail(function (jqXHR, textStatus, errorThrown){
		     			});
	    			}
	    			$(function() {
	    				setInterval("updateIsBeingProcessed();", 1000);
	    			});
    			</script>
    			
    			<script>
    			function addPreview(pv, fileId){
    				String.prototype.endsWith = function(str)
    				{
    				    var lastIndex = this.lastIndexOf(str);
    				    return (lastIndex != -1) && (lastIndex + str.length == this.length);
    				}
    				
    				var prevsOfFile = parseInt($("#filePrevContainer_" + fileId).attr('data-previewsCount'))
    				var newTabLink = document.createElement('a');
    				newTabLink.setAttribute('href', '#previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				$("#filePrevContainer_" + fileId).attr('data-previewsCount', '' + (prevsOfFile + 1));
    				newTabLink.setAttribute('data-toggle', 'tab');
    				newTabLink.innerHTML= pv.p_id;
    				var newListItem = document.createElement('li');
    				newListItem.appendChild(newTabLink);
    				$("#myTab_" + fileId).append(newListItem);
    				
    				var newPrevDiv = document.createElement('div');
    				newPrevDiv.setAttribute('class', 'tab-pane previewDiv');
    				newPrevDiv.setAttribute('id', 'previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				newPrevDiv.setAttribute('data-previewId', pv.pv_id);
    				newPrevDiv.setAttribute('data-previewerId', pv.p_id);
    				$("#previewsContent_" + fileId).append(newPrevDiv);
    				
    				//Previewer config vars
    				Configuration.tab = '#previewer_' + fileId +  '_' + (prevsOfFile + 1);
    				Configuration.url = pv.pv_route;
    				Configuration.fileid = pv.pv_id;
    				Configuration.previewer = pv.p_path;
    				if(pv.p_id === "Thumbnail"){
    					Configuration.fileType = pv.pv_contenttype;
    					Configuration.fileSize = pv.pv_length;			
    				}
    				else if(pv.p_id === "X3d"){							
    					Configuration.annotationsEditPath = pv.pv_annotationsEditPath;
    					Configuration.annotationsListPath = pv.pv_annotationsListPath;
    					Configuration.annotationsAttachPath = pv.pv_annotationsAttachPath;
    					if($("#previewedFileName_" + fileId +" :nth-child(1)").text().endsWith(".ptm"))   					
    						Configuration.wasPTM = 'true';
    					else
    						Configuration.wasPTM = 'false';
    				}
    				////
    				
    				var s = document.createElement("script");
    				s.type = "text/javascript";
    				s.src = pv.p_path + "/" + pv.p_main;
    				$("#previewsContent_" + fileId).append(s);
    				
    				if(prevsOfFile == 1){
    					$("#myTab_" + fileId).attr('style', 'display:block;');
    				}

    				else if(prevsOfFile == 0 && ($("#technicalMetadata_" + fileId).length == 0) && ($("#fileUserMetadata_" + fileId).length == 0)){   					
    					$("#filePrevContainer_" + fileId).before("<div id='previewedFileName_" + fileId + "' class='filenameDiv'><h4  style='font-weight:bold;'>" + $("#filePrevContainer_" + fileId).attr("data-filename")  + "</h4></div>");

    					var followingVisibleFiles = $("#filePrevContainer_" + fileId).nextAll(".filenameDiv");
    					if(followingVisibleFiles.length > 0){
    						followingVisibleFiles[0].before("<hr class='file_separator'></hr>");
    					}
    					else{
    						var previousVisibleFiles = $("#previewedFileName_" + fileId).prevAll(".filenameDiv");
    						if(previousVisibleFiles.length > 0){
    							$("#previewedFileName_" + fileId).before("<hr class='file_separator'></hr>");
        					}
    					}			
    				}
    				
    				
    				$('#myTab_' + fileId + ' a:first').tab('show');
    			}
    		
    			function checkForNewPreviews(){
	    			var request = $.ajax({
					       type: 'GET',  
					       url: "@api.routes.Datasets.getPreviews(dataset.id.toString)",
					       contentType: "application/json"
					     });
					request.done(function (respJSON){
							//alert(JSON.stringify(respJSON));
						for(var i = 0; i < respJSON.length; i++){
							var pvs = respJSON[i].previews;
							for(var j = 0; j < pvs.length; j++){
								var pvId = pvs[j].pv_id;
								var pId = pvs[j].p_id;
								if($(".previewDiv[data-previewId='" + pvId + "'][data-previewerId='" + pId + "']").length == 0){
									addPreview(pvs[j], respJSON[i].file_id);
								}
							}
						}
						setTimeout("checkForNewPreviews();", 1000);
		     		});				 
					  request.fail(function (jqXHR, textStatus, errorThrown){
		        		setTimeout(function(){checkForNewPreviews()}, 1000);
		     			});
				}
    			$(function() {
    				setTimeout(function(){checkForNewPreviews()}, 1000);
    			});
    		</script>
    		
    		<script>
    			function updateFiles(){
    				var request = $.ajax({
 				       type: 'GET',  
 				       url: "@api.routes.Datasets.datasetFilesList(dataset.id.toString)",
 				       contentType: "application/json"
 				     });
    				request.done(function (respJSON){
    					for(var i = 0; i < respJSON.length; i++){
    						if($("#filePrevContainer_"+respJSON[i].id).length == 0){
    							var fileId = respJSON[i].id;
    							$("#bottomDatasetTabbable").before("<div class='row' id='filePrevContainer_"+fileId+"' data-previewsCount='0' data-filename='"+respJSON[i].filename+"'>"
    													+"<div class='span12'><div class='tabbable'><ul class='nav nav-pills' id='myTab_"+fileId+"'></ul>"
    													+"<div class='tab-content' id='previewsContent_"+fileId+"'></div></div></div></div>");
    							$('#myTab_'+fileId).attr('style', 'display:none;');
    							
    							var tableLength = $("#datasetFilesTable tbody tr").length;
    							var j = 1;
							        while(j <= tableLength && $("#datasetFilesTable tbody tr:nth-child("+j+") td:nth-child(1) a").text() < respJSON[i].filename){
							        	j++;
							        }

						        if(j <= tableLength)	    
							        $("#datasetFilesTable tbody tr:nth-child("+j+")").before("<tr><td><a href='http://"+Configuration.hostIp+":"+window.location.port+"/files/"+fileId+"'>"+respJSON[i].filename+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='detachFile(\""+fileId+"\",\""+respJSON[i].filename+"\",event)'>Detach</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFile(\""+fileId+"\",event,true)'>Delete</a></td></tr>"
							        		);
						        else if(tableLength > 0)
						        	$("#datasetFilesTable tbody tr:nth-child("+(j-1)+")").after("<tr><td><a href='http://"+Configuration.hostIp+":"+window.location.port+"/files/"+fileId+"'>"+respJSON[i].filename+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='detachFile(\""+fileId+"\",\""+respJSON[i].filename+"\",event)'>Detach</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFile(\""+fileId+"\",event,true)'>Delete</a></td></tr>"
							        		);
						        else{
						        	if($("#datasetFilesTable tbody").length == 0)
						        		$("#datasetFilesTable").append("<tbody></tbody>");
						        	$("#datasetFilesTable tbody").append("<tr><td><a href='http://"+Configuration.hostIp+":"+window.location.port+"/files/"+fileId+"'>"+respJSON[i].filename+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='detachFile(\""+fileId+"\",\""+respJSON[i].filename+"\",event)'>Detach</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFile(\""+fileId+"\",event,true)'>Delete</a></td></tr>"
							        		);
						        	}
    						}
    					}
    					setTimeout(function(){updateFiles()}, 2000);
	     			});				 
				  request.fail(function (jqXHR, textStatus, errorThrown){
	        		setTimeout(function(){updateFiles()}, 2000);
	     			});
    			}
    			$(function() {
    				setTimeout(function(){updateFiles()}, 2000);
    			});
    		</script> -->
		</div>
	</div>
	
}
