@(file: models.File, id: String, comments: List[Comment], previews : Map[models.File, Array[(java.lang.String, String, String, String, java.lang.String, String, Long)]], sections: List[models.Section], beingProcessed: Boolean, fileDataset: List[models.Dataset], datasetsOutside: List[models.Dataset], usrmd: scala.collection.mutable.Map[String,Any], rdfExported: Boolean, rightsForUser: Option[models.UserPermissions])(implicit user: Option[securesocial.core.Identity])

@import helper._
@import collection.JavaConverters._
@import controllers.{Datasets, Files}
@import services.{DI, AppConfigurationService, UserAccessRightsService}
@import securesocial.core.{SocialUser, IdentityId, AuthenticationMethod}
@import play.api.Play.current 
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

@printLevel(metadata: scala.collection.immutable.Map[String,Any]) = {		
		@for((key,value) <- metadata) {
			<li><b>@(key):</b>
			@if(value.isInstanceOf[String]) {
				@if(value.asInstanceOf[String].startsWith("http://") || value.asInstanceOf[String].startsWith("https://")) {
					<a href="@value">@value</a>
				} else {
					@value
				}
			} else {
				@if(value.isInstanceOf[java.lang.Integer]) {
					@value.toString
			    } else {
			    	@if(value.isInstanceOf[com.mongodb.BasicDBList]) {
			    		@value.toString.replace("[","").replace("]","")
			    	} else {
			    		<ul>
			    		@printLevel(value.asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
			    		</ul>
			    	}
			    }
			}</li>
		}
	} 

@showPreview(id: String, p: (java.lang.String, String, String, String, java.lang.String, String, Long), filename: String, contentType: String, originalFileId: String) = {
	<script>
		Configuration.tab = "#previewer_@id";
		Configuration.url = "@p._5";
		Configuration.fileid = "@p._1";
		Configuration.previewer = "@routes.Assets.at(p._3)";
		if("@p._2" === "Thumbnail"){
			Configuration.fileType = "@p._6";
			Configuration.fileSize = @p._7;			
		}
		else if("@p._2" === "X3d"){							
			Configuration.annotationsEditPath = "@api.routes.Previews.editAnnotation(UUID(p._1), UUID(originalFileId))";
			Configuration.annotationsListPath = "@api.routes.Previews.listAnnotations(UUID(p._1))";
			Configuration.annotationsAttachPath = "@api.routes.Previews.attachAnnotation(UUID(p._1), UUID(originalFileId))";
			Configuration.annotationsDeletePath = "@api.routes.Previews.deleteAnnotation(UUID(p._1), UUID(originalFileId))";
			Configuration.wasPTM = "@(filename.endsWith(".ptm") || contentType.contains("ptmimages"))";
			Configuration.calledFrom = "file";
		}
		else if("@p._2" === "Oni"){							
		}
		else if("@p._2" === "IIP-Javascript"){
			Configuration.iipIframe = "@(routes.Assets.at("javascripts/previewers/iipJS/iipIframe.html"))";
		}
		else if("@p._2" === "Multispectral"){
			Configuration.multispectralIframe = "@(routes.Assets.at("javascripts/previewers/multispectral/multispectralIframe.html"))";
		}
		else if("@p._2" === "Video" || "@p._2" === "Video"){
			Configuration.originalFileId = "@originalFileId";
		}
	</script>
	<script type="text/javascript" src="@(routes.Assets.at(p._3) + "/" + p._4)"></script>
}


@main("File") {
@defining(services.DI.injector.getInstance(classOf[controllers.Files]).checkAccessForFileUsingRightsList(file, user, "modify", rightsForUser)){authenticatedFileModify=>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
	<script src="@routes.Assets.at("javascripts/previews.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("javascripts/tinymce/tinymce.min.js")" type="text/javascript"></script>
	<script>
		tinymce.init({selector:'.notesArea',
	    	theme: "modern",
	    	plugins: [
	    	          "advlist autolink lists link image charmap print preview hr anchor pagebreak",
	    	          "searchreplace wordcount visualblocks visualchars code fullscreen",
	    	          "insertdatetime media nonbreaking save table contextmenu directionality",
	    	          "template paste textcolor"
	    	      ],
	    	      toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
	    	      toolbar2: "print preview media | forecolor backcolor emoticons",
	    	      image_advtab: true,
	    	      templates: [
	    	          {title: 'Test template 1', content: 'Test 1'},
	    	          {title: 'Test template 2', content: 'Test 2'}
	    	      ]
	    });
	</script>
	<script>
    	var isPageLoaded = false;
    	var isx3dActive = false;
    	var Configuration = {};
    	Configuration.id  = "@file.id";
		Configuration.authenticated = @user.isDefined;
		Configuration.authenticatedIndividualResource = @(services.DI.injector.getInstance(classOf[controllers.Files]).checkAccessForFileUsingRightsList(file, user, "modify", rightsForUser));
		Configuration.ptmAppletPath = "@(routes.Assets.at("plugins") + "/" + "envlib.jar")";
		Configuration.expressInstallPath = "@(routes.Assets.at("plugins") + "/" + "expressInstall.swf")";
		Configuration.iipZoomPath = "@(routes.Assets.at("plugins") + "/" + "IIPZoom.swf")";
		Configuration.jsPath = "@(routes.Assets.at("javascripts"))";
		Configuration.imagesPath = "@(routes.Assets.at("images"))";
		Configuration.presentationsMediumQualityLimit = @(play.api.Play.configuration.getInt("presentationPreviewsSettings.mediumQualityLimit").getOrElse(0));
		Configuration.presentationsHighQualityLimit = @(play.api.Play.configuration.getInt("presentationPreviewsSettings.highQualityLimit").getOrElse(0));
		Configuration.stylesheetsPath = "@(routes.Assets.at("stylesheets"))";
    </script>
    <script>
    	window.onload = function() {
    		isPageLoaded = true;
    	}
    </script>
	
	<div class="page-header">
		<h1>@file.filename</h1>
	</div>
	<div class="row">
	<div class="col-md-2">				
	
		</div>
		
		<div class="col-md-6">
			<dl class="dl-horizontal">
				<dt>Author:</dt>
				<dd>@file.author.fullName</dd>
				<dt>Filename:</dt>
				<dd>@file.filename</dd>
				<dt>Type:</dt>
				<dd>@file.contentType</dd>
				<dt>Uploaded on:</dt>
				<dd>@file.uploadDate</dd>				
			</dl>
		</div>
		</div>
		
	<div class="row">
		<div class="col-md-12">
		@for((f, pvs) <- previews) {
			<div class="row" id="filePrevContainer_@(f.id.toString)" data-previewsCount="@(pvs.length)" data-filename="@f.filename">
		    	<div class="col-md-12">
				  		<div class="tabbable">
							<ul class="nav nav-pills" id="myTab_@(f.id.toString)">
								@for(i <- pvs.indices) {
						    		<li class=""><a href="#previewer_@(f.id.toString)_@i" data-toggle="tab">@pvs(i)._2</a></li>
				  				}
							</ul>
							<div class="tab-content"  id="previewsContent_@(f.id.toString)">
								@for(i <- pvs.indices) {
							  		<div class="tab-pane previewDiv" id="previewer_@(f.id.toString)_@i" data-previewId="@(pvs(i)._1)" data-previewerId="@(pvs(i)._2)"></div>
							  		@showPreview(f.id.toString + "_" + i, pvs(i), f.filename, f.contentType, f.id.toString)

								}
					  			<script type="text/javascript">
									$(function () {
										$('#myTab_@(f.id.toString) a:first').tab('show');
					 				 })
								</script>
							</div>
						</div>
					
		  		</div>
			</div>
			@if(pvs.length <= 1) {
				<script>
	    			$('#myTab_@(f.id.toString)').attr('style', 'display:none;');
	    		</script>
    		}
			
			<!-- sections -->
			@if(sections.size > 0) {	
			  	<div class="row" style="padding-top: 10px">
			  	  <div class="col-md-6">
				  	<div id="galleria_@(f.id.toString)" style="float:left;clear:none;width:600px;height:300px;">
					  	@sections.map { s =>
					  		@if(s.preview.isDefined) {
					  			<img src="@api.routes.Previews.download(s.preview.get.id)"
					  				class="img-polaroid" height="100px" 
					  			@if(s.startTime.isDefined) {
					  		 		data-title="Shot" data-description="Starts at @s.startTime seconds."
					  		 	} else {
					  		 		if (s.area.isDefined) {
					  		 			data-title="Area" data-description="@s.area.toString"
					  		 		} else {
										data-title="Unknown" data-description="Unknown info"
					  		 		}
					  		 	}
					  		 	></img>
					  		}
					  	}
				  	</div>
				  </div>
				</div>
				  
				<div class="row" style="padding-top: 10px">
				  <div class="col-md-10">
				  	<div>
				  		<h5>Sections</h5>
						<table class="table">
							<thead>
								<tr>
									<th>#</th>
									<th>Thumbail</th>
									<th>Information</th>
									<th>Find</th>
								</tr>
							</thead>
							<tbody>
					  		@sections.map { s =>
					  			<tr>
						  			<td>@(if (s.order > 0) s.order else "")</td>
						  			<td>
								  		@if(s.preview.isDefined) {
								  			<img src="@api.routes.Previews.download(s.preview.get.id)"
								  				class="img-polaroid" style="max-width: 100px;max-height: 100px;" 
								  			@if(s.startTime.isDefined) {
								  		 		data-title="Shot" data-description="Starts at @s.startTime seconds." data_time="@s.startTime"
								  		 	} else {
								  		 		@if(s.area.isDefined) {
								  		 			data-title="Area" data-description="@s.area.toString"
								  		 		} else {
													data-title="Unknown" data-description="Unknown info"
								  		 		}
								  		 	}
								  		 	></img>
								  		 }
					  				</td>
						  			 <td>
						  			 @if(s.startTime.isDefined) {
						  			 	@(s.startTime.get / 60):@("%02d".format(s.startTime.get % 60))
						  		 	 } else {
						  		 		@if(s.area.isDefined) {
						  		 			@s.area.toString
						  		 		} else {
											Unknown info
						  		 		}
						  		 	}
						  			 </td>
						  			 <td><a href="@routes.Search.searchMultimediaIndex(s.id)">Similar</a></td>
					  			 </tr>
					  		}
				  		</table>
				  	</div>
				  </div>
			  	</div>

				<script src="http://popcornjs.org/code/dist/popcorn-complete.min.js" type="text/javascript"></script>
				<script>
// 				    document.addEventListener("DOMContentLoaded", function () {
// 						if ($("#ourvideo").length>0) {
// 					        var pop = Popcorn("#ourvideo");
					       
// 							@sections.map { s =>
// 					  			@if(s.startTime.isDefined) {
// 							   		pop.code({
// 								        start: @s.startTime,
// 								        onStart: function() {
// 								          var frame = @s.order - 1;
// 								          console.log("Jumping to " + frame + " " + @s.startTime);
// 								          $('#galleria').data('galleria').show(frame);
// 								        },
// 								        onEnd: function() {
// 								       }
// 								    });
// 								}
// 						    }
// 						}
// 				    });
		         </script>
													
			    <script>
			    	$(function() {
					    // Load the classic theme
					    Galleria.loadTheme('@routes.Assets.at("javascripts/galleria-classic/galleria.classic.min.js")');
					
					    // Initialize Galleria and, if for a video, onclick events for going to time of selected image when clicking main image
					    Galleria.run('#galleria_@(f.id.toString)', {					   		
						        extend: function(options) {
						          if ($("#ourvideo_@(f.id.toString)").length>0) {
						            Galleria.log(this); // the gallery instance
						            Galleria.log(options); // the gallery options
					    
						            // listen to when an image is shown
						            this.bind('image', function(e) {
					    
						                Galleria.log(e); // the event object may contain custom objects, in this case the main image
						                Galleria.log(e.imageTarget); // the current image
						
						                // lets make galleria make the video jump to the time of the selected image when clicking it:
						                $(e.imageTarget).click(this.proxy(function(){
						                	var pop = Popcorn("#ourvideo_@(f.id.toString)");
						                	pop.currentTime(parseInt(this._data[this._active].description.match(/\d+/)[0]));
						                }));
						            });
						          }
						        }
					    });
				    });
			    </script>
    			}
    		}
						
    		<script>
    					Galleria.ready(function(options) {
						    this.bind('image', function(e) {
						        Galleria.log('Now viewing ' + e.imageTarget.src);
						    });
						});
    		</script>

			@if(!file.metadata.isEmpty) {
					<div id='technicalMetadata_@(file.id)'>
						<button class="tech_md_" type="button">Show file technical metadata</button>
						<div style="display:none;">
						<ul>
							@for(i <- 0 until file.metadata.length){								
								@printLevel(file.metadata(i).asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
							}
						</ul>
						</div>
					</div>
					<script>
						$("#technicalMetadata_@(file.id.toString) > button").on('click',function(){
							if($("#technicalMetadata_@(file.id.toString) > div").attr('style') == 'display:none;'){
								$("#technicalMetadata_@(file.id.toString) > div").attr('style', 'display:block;');
								$("#technicalMetadata_@(file.id.toString) > button").get(0).innerHTML = "Hide file technical metadata";
							}
							else{
								$("#technicalMetadata_@(file.id.toString) > div").attr('style', 'display:none;');
								$("#technicalMetadata_@(file.id.toString) > button").get(0).innerHTML = "Show file technical metadata";
							}
						});
					</script>
				}
			@if(!file.xmlMetadata.isEmpty) {
					<div id='xmlMetadata_@(file.id.toString)'>
						<button class="tech_md_" type="button">Show XML-uploaded metadata</button>
						<div style="display:none;">
						<ul>								
								@printLevel(file.xmlMetadata)
						</ul>
						</div>
					</div>
					<script>
						$("#xmlMetadata_@(file.id.toString) > button").on('click',function(){
							if($("#xmlMetadata_@(file.id.toString) > div").attr('style') == 'display:none;'){
								$("#xmlMetadata_@(file.id.toString) > div").attr('style', 'display:block;');
								$("#xmlMetadata_@(file.id.toString) > button").get(0).innerHTML = "Hide file XML-uploaded metadata";
							}
							else{
								$("#xmlMetadata_@(file.id.toString) > div").attr('style', 'display:none;');
								$("#xmlMetadata_@(file.id.toString) > button").get(0).innerHTML = "Show file XML-uploaded metadata";
							}
						});	
					</script>
				}	
				
				
				
			</div>
    	</div>
		@if(beingProcessed == true){
    			<div id='beingProcessed' style='display:block;'><h5>File is being processed...</h5></div>  		
    		}else{
    			<div id='beingProcessed' style='display:none;'><h5>File is being processed...</h5></div> 
    		}
    		<script>
    			function updateIsBeingProcessed(){  
    				var request = $.ajax({
 				       type: 'GET',  
 				       url: "@api.routes.Files.isBeingProcessed(file.id)",
 				       contentType: "application/json"
 				     });
    				request.done(function (respJSON){
						if(respJSON.isBeingProcessed == "true")
							$("#beingProcessed").css('display','block');
						else
							$("#beingProcessed").css('display','none');
	     			});				 
				  request.fail(function (jqXHR, textStatus, errorThrown){
	        		console.error(
	            		"The following error occured: "+
	            		textStatus, errorThrown		            
	        			);
	        		//alert("ERROR: " + errorThrown +". Processing of dataset not checked." );
	     			});
    			}
    			$(function() {
    				setInterval("updateIsBeingProcessed();", 1000);
    			});   
    		</script>
    		<script>
    			function addPreview(pv, fileId){
    				String.prototype.endsWith = function(str)
    				{
    				    var lastIndex = this.lastIndexOf(str);
    				    return (lastIndex != -1) && (lastIndex + str.length == this.length);
    				}
    				
    				var prevsOfFile = parseInt($("#filePrevContainer_" + fileId).attr('data-previewsCount'))
    				var newTabLink = document.createElement('a');
    				newTabLink.setAttribute('href', '#previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				$("#filePrevContainer_" + fileId).attr('data-previewsCount', '' + (prevsOfFile + 1));
    				newTabLink.setAttribute('data-toggle', 'tab');
    				newTabLink.innerHTML= pv.p_id;
    				var newListItem = document.createElement('li');
    				newListItem.appendChild(newTabLink);
    				$("#myTab_" + fileId).append(newListItem);
    				
    				var newPrevDiv = document.createElement('div');
    				newPrevDiv.setAttribute('class', 'tab-pane previewDiv');
    				newPrevDiv.setAttribute('id', 'previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				newPrevDiv.setAttribute('data-previewId', pv.pv_id);
    				newPrevDiv.setAttribute('data-previewerId', pv.p_id);
    				$("#previewsContent_" + fileId).append(newPrevDiv);
    				
    				//Previewer config vars
    				Configuration.tab = '#previewer_' + fileId +  '_' + (prevsOfFile + 1);
    				Configuration.url = pv.pv_route;
    				Configuration.fileid = pv.pv_id;
    				Configuration.previewer = pv.p_path;
    				if(pv.p_id === "Thumbnail"){
    					Configuration.fileType = pv.pv_contenttype;
    					Configuration.fileSize = pv.pv_length;			
    				}
    				else if(pv.p_id === "X3d"){							
    					Configuration.annotationsEditPath = pv.pv_annotationsEditPath;
    					Configuration.annotationsListPath = pv.pv_annotationsListPath;
    					Configuration.annotationsAttachPath = pv.pv_annotationsAttachPath;
    					Configuration.annotationsDeletePath = pv.pv_annotationsDeletePath;
    					if("@file.filename".endsWith(".ptm") || "@file.contentType".indexOf("ptmimages") != -1)   					
    						Configuration.wasPTM = 'true';
    					else
    						Configuration.wasPTM = 'false';
    					Configuration.calledFrom = "file";
    				}
    				else if(pv.p_id === "Multispectral"){
    					Configuration.multispectralIframe = "@(routes.Assets.at("javascripts/previewers/multispectral/multispectralIframe.html"))";
    				}
    				////
    				
    				var s = document.createElement("script");
    				s.type = "text/javascript";
    				s.src = pv.p_path + "/" + pv.p_main;
    				$("#previewsContent_" + fileId).append(s);
    				
    				if(prevsOfFile == 1){
    					$("#myTab_" + fileId).attr('style', 'display:block;');
    				}
    				    				
    				$('#myTab_' + fileId + ' a:first').tab('show');
    			}
    		
    			function checkForNewPreviews(){
	    			var request = $.ajax({
					       type: 'GET',  
					       url: "@api.routes.Files.getPreviews(file.id)",
					       contentType: "application/json"
					     });
					request.done(function (respJSON){
							//alert(JSON.stringify(respJSON));
						for(var i = 0; i < respJSON.length; i++){
							var pvs = respJSON[i].previews;
							for(var j = 0; j < pvs.length; j++){
								var pvId = pvs[j].pv_id;
								var pId = pvs[j].p_id;
								if($(".previewDiv[data-previewId='" + pvId + "'][data-previewerId='" + pId + "']").length == 0){
									addPreview(pvs[j], respJSON[i].file_id);
								}
							}
						}
						setTimeout("checkForNewPreviews();", 1000);
		     		});				 
					  request.fail(function (jqXHR, textStatus, errorThrown){
		        		console.error(
		            		"The following error occured: "+
		            		textStatus, errorThrown		            
		        			);
		        		//alert("ERROR: " + errorThrown +". Did not check for new previews." );
		        		setTimeout(function(){checkForNewPreviews()}, 1000);
		     			});
				}
    			$(function() {
    				setTimeout(function(){checkForNewPreviews()}, 1000);
    			});
    		</script> 
    		
    		

		<div class="col-md-4">
			<a href="@routes.Files.download(UUID(id))" class="btn btn-default pull-right" style="margin-top:2%;" target="_blank">Download</a>
		</div>

	</div>
	<div id="accordionsDiv" class="row" style="margin-top:20px; width: 750px; padding-left:15px;">
		<div class="accordion" id="accordion5">
			<div class="accordion-group">
				<div class="accordian-heading">
					<a class="accordion-toggle" data-toggle="collapse"
						data-parent="#accordion5" href="#collapseFive">Notes</a>
				</div>
				<div id="collapseFive" class="accordion-body in collapse">
			      		@notesform(file.id.toString, api.routes.Files.setNotesHTML(file.id).toString, file.notesHTML.getOrElse(""), file.author.identityId.userId, authenticatedFileModify)
				</div>
			</div>
		</div>
	
		<div class="accordion" id="accordion1">
			<div class="accordion-group">
				<div class="accordian-heading">
					<a class="accordion-toggle" data-toggle="collapse"
						data-parent="#accordion1" href="#collapseOne">Comments</a>
				</div>
				<div id="collapseOne" class="accordion-body in collapse">
			      	@if(user.isDefined) {
			      		@commentform(file.id.toString, api.routes.Files.comment(file.id).toString)
			      	}
			 		<ol class="comment-threads unstyled" id="reply_@file.id.toString">
				    	@comment(comments)
				    </ol>
				</div>
			</div>
		</div>
		
		<!--Debug code-->
		@if(false){ 
			<div class="accordion" id="accordion2">
				<div class="accordion-group">
					<div class="accordian-heading">
						<a class="accordion-toggle" data-toggle="collapse"
							data-parent="#accordion2" href="#collapseTwo">Debug</a>
					</div>
					<div id="collapseTwo" class="accordion-body collapse">
						<div class="accordion-inner">@file</div>
						<div class="accordion-inner">Previews:
							<ul>
								@previews.map { p =>
								<li>@p</li>
							}
							</ul>
						</div>
						<div class="accordion-inner">Sections:
							<ul>
							@sections.map { s =>
								<li>@s</li>
							}
							</ul>
						</div>
					</div>
				</div>
			</div>
		}
		<!--End of debug code-->
		
			<div class="accordion" id="accordion3">
				<div class="accordion-group">
					<div class="accordian-heading">
						<a class="accordion-toggle" data-toggle="collapse"
							data-parent="#accordion3" href="#collapseThree">User-generated metadata</a>
					</div>
					<div id="collapseThree" class="accordion-body in collapse">
				      	@fileusermetadata(file, usrmd, rdfExported, rightsForUser)
					</div>
				</div>
			</div>  
			
			<div class="accordion" id="accordion4">
				<div class="accordion-group">
					<div class="accordian-heading">
						<a class="accordion-toggle" data-toggle="collapse"
							data-parent="#accordion4" href="#collapseFour">Datasets containing the file</a>
					</div>
					<div id="collapseFour" class="accordion-body in collapse">
				      	<table id="datasTable">
						@fileDataset.map { dataset =>
							<tr><td><a href="@(routes.Datasets.dataset(dataset.id))">@dataset.name</a>&nbsp;&nbsp;&nbsp;&nbsp;</td>
							<td class="requiresLogin requiresLoginCommunity">
									@if(services.DI.injector.getInstance(classOf[controllers.Datasets]).checkAccessForDatasetUsingRightsList(dataset, user, "modify", rightsForUser)){
										<a href="#!" style="font-style:italic;" onclick="removeFromDataset('@(dataset.id)','@(dataset.name)',event)">Detach</a>
									}																				
							</td>
							</tr>
						}
						</table>
						<div class="ui-widget requiresLogin requiresLoginCommunity" id="datasetsUi">
							<select id="datasetAddSelect" data-inputid="selectingInputDatasets" data-errorid="doesNotExistErrorDatasets">
							@datasetsOutside.map { dataset =>
										<option value="@(dataset.id.toString)">@(dataset.name)</option>
							}					  
							</select>
							<button class="btn combobutton" id="addDatasBtn" style="vertical-align:top;">Add to dataset</button>
							<span style="color:red;display:none;margin-top:10px;font-size:14px;font-family:Helvetica Neue,Helvetica,Arial,sans-serif" id="doesNotExistErrorDatasets" >Dataset does not exist or already added.</span>
						</div>
						<script src="@routes.Assets.at("javascripts/book.js")" type="text/javascript"></script>	
						<script src="@routes.Assets.at("javascripts/combobox.js")" type="text/javascript"></script>
						<script>
							$("#datasetAddSelect").combobox();
						</script>
						<script>
								$('body').on('click','#addDatasBtn',function(e){
									if($("#doesNotExistErrorDatasets").css('display') == 'inline')
										return;
									if($("#selectingInputDatasets").val() == ""){
										$("#doesNotExistErrorDatasets").css('display','inline');
										return;
									}
									
									var selectedId = $("#datasetAddSelect").val();
									var selectedName = $("#datasetAddSelect option:selected").text();
									var request = $.ajax({
									       type: 'POST',
									       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/datasets/"+selectedId+"/files/"+"@file.id"
									     });
									request.done(function (response, textStatus, jqXHR){
								        console.log("Response " + response);	        
								        $("#datasetAddSelect option[value=" + selectedId + "]").remove();
								        $("#selectingInputDatasets").val("");
								        var i = 1;
								        var tableLength = $("#datasTable tbody tr").length;
								        while(i <= tableLength && $("#datasTable tbody tr:nth-child("+i+") td:nth-child(1) a").text() < selectedName)
								        	i++;
								        if(i <= tableLength)	        
									        $("#datasTable tbody tr:nth-child("+i+")").before("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/datasets/"+selectedId+"'>"+selectedName+"</a>"
									        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFromDataset(\""+selectedId+"\",\""+selectedName+"\",event)'>Detach</a></td></tr>"
									        		);
								        else if(tableLength > 0)
								        	$("#datasTable tbody tr:nth-child("+(i-1)+")").after("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/datasets/"+selectedId+"'>"+selectedName+"</a>"
									        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFromDataset(\""+selectedId+"\",\""+selectedName+"\",event)'>Detach</a></td></tr>"
									        		);
								        else{
								        	if($("#datasTable tbody").length == 0)
								        		$("#datasTable").append("<tbody></tbody>");
								        	$("#datasTable tbody").append("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/datasets/"+selectedId+"'>"+selectedName+"</a>"
									        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFromDataset(\""+selectedId+"\",\""+selectedName+"\",event)'>Detach</a></td></tr>"
									        		);
								        	}
									});	
									request.fail(function (jqXHR, textStatus, errorThrown){
							    		console.error(
							        		"The following error occured: "+
							        		textStatus, errorThrown		            
							    			);
							    		alert("ERROR: " + errorThrown +". File not added to dataset. The dataset or file was possibly removed." );
							 			});				
								});
								
								function removeFromDataset(datasetId, datasetName,event){
									var request = $.ajax({
									       type: 'POST',
									       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/datasets/"+datasetId+"/filesRemove/"+"@file.id"+"/True"
									     });
									request.done(function (response, textStatus, jqXHR){
										console.log("Response " + response);	        
										$(event.target.parentNode.parentNode).remove();
										var i = 1;
								        var selectLength = $("#datasetAddSelect option").length;
								        while(i <= selectLength && $("#datasetAddSelect option:nth-child("+i+")").text() < datasetName)
								        	i++;
								        if(i <= selectLength)
								        	$("#datasetAddSelect option:nth-child("+i+")").before("<option value='"+datasetId+"'>"+datasetName+"</option>");
								        else if(selectLength > 0)
								        	$("#datasetAddSelect option:nth-child("+(i-1)+")").after("<option value='"+datasetId+"'>"+datasetName+"</option>");
								        else
								        	$("#datasetAddSelect").append("<option value='"+datasetId+"'>"+datasetName+"</option>");
								        
								        $("#datasetAddSelect").combobox();
									});	
									request.fail(function (jqXHR, textStatus, errorThrown){
							    		console.error(
							        		"The following error occured: "+
							        		textStatus, errorThrown		            
							    			);
							    		alert("ERROR: " + errorThrown +". File not removed from dataset." );
							 			});
								}
								
						</script>
						 
					</div>
				</div>
			</div>
			    	@if(services.DI.injector.getInstance(classOf[controllers.Files]).checkAccessForFileUsingRightsList(file, user, "administrate", rightsForUser)){
			    		<div class="accordion" id="accordionAccessRights">
							<div class="accordion-group">
								<div class="accordian-heading">
									<a class="accordion-toggle" data-toggle="collapse"
										data-parent="#accordionAccessRights" href="#collapseAccessRights">Administrate</a>
								</div>
								<div id="collapseAccessRights" class="accordion-body in collapse">
							      	@setResourceAccessRights("file", file.id.stringify, file.isPublic.getOrElse(false), Some(file.author))
								</div>
							</div>
						</div>
			    	}
		
		
	</div>
	<script>
	    var newOffsetLeft = $("#wrap > .container").offset().left;
	    var newOffsetTop = $("#accordionsDiv").offset().top;
	
	
		$("#accordionsDiv").offset({ top: newOffsetTop, left: newOffsetLeft })   ;	
	
	</script>
		@if(!user.isDefined) {
     	   <script language="javascript">
     			$(".requiresLogin").css("display","none");
       	   </script>
     	 }

     	 	@if(!authenticatedFileModify){
      	   		<script language="javascript">
	     			$(".requiresLogin:not(.requiresLoginCommunity)").css("display","none");
	       		</script>
       		}
}
}
