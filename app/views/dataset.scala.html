@(dataset: models.Dataset, comments: List[Comment], previews : Map[models.File, Array[(java.lang.String, String, String, String, java.lang.String, String, Long)]], md: Map[String,Any], usrmd: scala.collection.mutable.Map[String,Any], beingProcessed: Boolean, collectionsOutside: List[models.Collection], collectionsInside: List[models.Collection], filesOutside: List[models.File], rdfExported: Boolean)(implicit user: Option[securesocial.core.Identity]) 


@import helper._
@import collection.JavaConverters._
@import com.mongodb.casbah.Imports.DBObject
@import services.{DI, AppConfigurationService}
@import securesocial.core.{SocialUser, IdentityId, AuthenticationMethod}
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

	@printLevel(metadata: scala.collection.immutable.Map[String,Any]) = {		
		@for((key,value) <- metadata) {
			<li><b>@(key):</b>
			@if(value.isInstanceOf[String]) {
				@if(value.asInstanceOf[String].startsWith("http://") || value.asInstanceOf[String].startsWith("https://")) {
					<a href="@value">@value</a>
				} else {
					@value
				}
			} else {
				@if(value.isInstanceOf[java.lang.Integer]) {
					@value.toString
			    } else {
			    	@if(value.isInstanceOf[com.mongodb.BasicDBList]) {
			    		@value.toString.replace("[","").replace("]","")
			    	} else {
			    		<ul>
			    		@printLevel(value.asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
			    		</ul>
			    	}
			    }
			}</li>
		}
	}
	
	@printLevelUserMetadata(metadata: scala.collection.mutable.Map[String,Any]) = {
		<ul class="usr_md_">
		@for((key,value) <- metadata) {
			@if(value.isInstanceOf[com.mongodb.BasicDBList]){
				@for(listValue <- value.asInstanceOf[com.mongodb.BasicDBList]) {
						<li class="usr_md_"><b class="usr_md_">@(key):</b>
						@if(listValue.isInstanceOf[String]) {			
							<span class="usr_md_">@listValue</span><button class="usr_md_" type="button">Modify</button><button class="usr_md_" >Delete</button>
						} else {
								<button class="usr_md_" type="button">Add property</button><button class="usr_md_" type="button">Delete</button>@printLevelUserMetadata(listValue.asInstanceOf[DBObject].toMap.asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]])
						}</li>
				}
			}else{
				<li class="usr_md_"><b class="usr_md_">@(key):</b>
				@if(value.isInstanceOf[String]) {			
					<span class="usr_md_">@value</span><button class="usr_md_" type="button">Modify</button><button class="usr_md_" >Delete</button>
				} else {
						<button class="usr_md_" type="button">Add property</button><button class="usr_md_" type="button">Delete</button>@printLevelUserMetadata(value.asInstanceOf[DBObject].toMap.asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]])
				}</li>
			}	
		}
		</ul>
	}

@showPreview(id: String, p: (java.lang.String, String, String, String, java.lang.String, String, Long), filename: String, contentType: String, originalFileId: String, authenticatedIndividualResource: Boolean) = {
	<script>
		Configuration.tab = "#previewer_@id";
		Configuration.url = "@p._5";
		Configuration.fileid = "@p._1";
		Configuration.previewer = "@routes.Assets.at(p._3)";
		Configuration.authenticatedIndividualResource = @authenticatedIndividualResource;
		if("@p._2" === "Thumbnail"){
			Configuration.fileType = "@p._6";
			Configuration.fileSize = @p._7;			
		}
		else if("@p._2" === "X3d"){							
			Configuration.annotationsEditPath = "@api.routes.Previews.editAnnotation(UUID(p._1), UUID(originalFileId))";
			Configuration.annotationsListPath = "@api.routes.Previews.listAnnotations(UUID(p._1))";
			Configuration.annotationsAttachPath = "@api.routes.Previews.attachAnnotation(UUID(p._1), UUID(originalFileId))";
			Configuration.annotationsDeletePath = "@api.routes.Previews.deleteAnnotation(UUID(p._1), UUID(originalFileId))";
			Configuration.wasPTM = "@(filename.endsWith(".ptm")  || contentType.contains("ptmimages"))";
			Configuration.calledFrom = "dataset";
		}
	</script>
	<script type="text/javascript" src="@(routes.Assets.at(p._3) + "/" + p._4)"></script>
}

@main("Dataset") {
@defining(user.getOrElse(new SocialUser(new IdentityId("anonymous", ""), "Anonymous", "User", "Anonymous User", None, None, AuthenticationMethod.UserPassword))){userOrAnon=>
@defining(DI.injector.getInstance(classOf[AppConfigurationService])
			.adminExists(userOrAnon.email.getOrElse(""))){userIsAdmin=>
	<script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/updateLicenseInfo.js")" language="javascript"></script>		
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
	<script src="@routes.Assets.at("javascripts/tinymce/tinymce.min.js")" type="text/javascript"></script>
	<script>
		tinymce.init({selector:'.notesArea',
	    	theme: "modern",
	    	plugins: [
	    	          "advlist autolink lists link image charmap print preview hr anchor pagebreak",
	    	          "searchreplace wordcount visualblocks visualchars code fullscreen",
	    	          "insertdatetime media nonbreaking save table contextmenu directionality",
	    	          "template paste textcolor"
	    	      ],
	    	      toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
	    	      toolbar2: "print preview media | forecolor backcolor emoticons",
	    	      image_advtab: true,
	    	      templates: [
	    	          {title: 'Test template 1', content: 'Test 1'},
	    	          {title: 'Test template 2', content: 'Test 2'}
	    	      ]
	    });
	</script>
    <script>
    	var isPageLoaded = false;
    	var isx3dActive = false;
    	var Configuration = {};
    	Configuration.id  = "@dataset.id";
		Configuration.authenticated = @user.isDefined;		
		Configuration.ptmAppletPath = "@(routes.Assets.at("plugins") + "/" + "envlib.jar")";
		Configuration.expressInstallPath = "@(routes.Assets.at("plugins") + "/" + "expressInstall.swf")";
		Configuration.iipZoomPath = "@(routes.Assets.at("plugins") + "/" + "IIPZoom.swf")";
		Configuration.jsPath = "@(routes.Assets.at("javascripts"))";
		Configuration.imagesPath = "@(routes.Assets.at("images"))";		
    </script>
    <script>
    	window.onload = function() {
    		$("#selectingInputFiles").val("");
    		isPageLoaded = true;
    	}
    </script>
    
	<div class="page-header">
		<h1 id="aboutname">@dataset.name</h1>
	</div>
	
	<div class="row">	
	
		<!-- left column -->
		<div class="col-md-8" id="filePrevsCol">
		@for((f, pvs) <- previews) {
			@defining(userIsAdmin || userOrAnon.identityId.userId.equals(f.author.identityId.userId)){authenticatedIndividualResource=>
				<div id='previewedFileName_@(f.id.toString)' class='filenameDiv'><h4 style="font-weight:bold;">@f.filename</h4></div>
			
				<div class="row" id="filePrevContainer_@(f.id.toString)" data-previewsCount="@(pvs.length)" data-filename="@f.filename" data-isAuthenticated="@authenticatedIndividualResource" style="margin-left:0px;">
		    		<div class="span12">
				  		<div class="tabbable">
							<ul class="nav nav-pills" id="myTab_@(f.id.toString)">
								@for(i <- pvs.indices) {
						    		<li class=""><a href="#previewer_@(f.id.toString)_@i" data-toggle="tab">@pvs(i)._2</a></li>
				  				}
							</ul>
							<div class="tab-content" id="previewsContent_@(f.id.toString)">
								@for(i <- pvs.indices) {
							  		<div class="tab-pane previewDiv" id="previewer_@(f.id.toString)_@i" data-previewId="@(pvs(i)._1)" data-previewerId="@(pvs(i)._2)"></div>
							  		@showPreview(f.id.toString + "_" + i, pvs(i), f.filename, f.contentType, f.id.toString, authenticatedIndividualResource)

								}
					  			<script type="text/javascript">
									$(function () {
					    				$('#myTab_@(f.id.toString) a:first').tab('show');
					 				 })
								</script>
							</div>
						</div>					
		  		</div>
			</div>
			@if(pvs.length <= 1) {
				<script>
	    			$('#myTab_@(f.id.toString)').attr('style', 'display:none;');
	    		</script>
    		}
			
			<!-- sections -->
			@if(f.sections.size > 0) {	
			  	<div class="row" style="padding-top: 10px">
			  	  <div class="col-md-6">
				  	<div id="galleria" style="float:left;clear:none;width:600px;height:300px;">
					  	@f.sections.map { s =>
					  		@if(s.preview.isDefined) {
					  			<img src="@api.routes.Previews.download(s.preview.get.id)"
					  				class="img-polaroid" height="100px" 
					  			@if(s.startTime.isDefined) {
					  		 		data-title="Shot" data-description="Starts at @s.startTime seconds."
					  		 	} else {
					  		 		if (s.area.isDefined) {
					  		 			data-title="Area" data-description="@s.area.toString"
					  		 		} else {
										data-title="Unknown" data-description="Unknown info"
					  		 		}
					  		 	}
					  		 	></img>
					  		}
					  	}
				  	</div>
				  </div>
				</div>
				  
				<div class="row" style="padding-top: 10px">
				  <div class="col-md-10">
				  	<div>
				  		<h5>Sections</h5>
						<table class="table">
							<thead>
								<tr>
									<th>#</th>
									<th>Thumbail</th>
									<th>Information</th>
									<th>Find</th>
								</tr>
							</thead>
							<tbody>
					  		@f.sections.map { s =>
					  			<tr>
						  			<td>
						  				@if(s.order != -1) {
						  					@s.order
						  				} else {
						  					*
						  				}
						  			</td>
						  			<td>
								  		@if(s.preview.isDefined) {
								  			<img src="@api.routes.Previews.download(s.preview.get.id)"
								  				class="img-polaroid" style="max-width: 100px;max-height: 100px;" 
								  			@if(s.startTime.isDefined) {
								  		 		data-title="Shot" data-description="Starts at @s.startTime seconds."
								  		 	} else {
								  		 		@if(s.area.isDefined) {
								  		 			data-title="Area" data-description="@s.area.toString"
								  		 		} else {
													data-title="Unknown" data-description="Unknown info"
								  		 		}
								  		 	}
								  		 	></img>
								  		 }
					  				</td>
						  			 <td>
						  			 @if(s.startTime.isDefined) {
						  			 	@(s.startTime.get / 60):@("%02d".format(s.startTime.get % 60))
						  		 	 } else {
						  		 		@if(s.area.isDefined) {
						  		 			@s.area.get.toString
						  		 		} else {
											Unknown info
						  		 		}
						  		 	}
						  			 </td>
						  			 <td><a href="@routes.Search.searchMultimediaIndex(s.id)">Similar</a></td>
					  			 </tr>
					  		}
				  		</table>
				  	</div>
				  </div>
			  	</div>

				<script src="@routes.Assets.at("javascripts/popcorn-complete.min.js")" type="text/javascript"></script>
				<script>
				    document.addEventListener("DOMContentLoaded", function () {
						if ($("#ourvideo").length>0) {				    
					        var pop = Popcorn("#ourvideo");
					       
							@f.sections.map { s =>
					  			@if(s.startTime.isDefined) {
							   		pop.code({
								        start: @s.startTime,
								        onStart: function() {
								          var frame = @s.order - 1;
								          console.log("Jumping to " + frame + " " + @s.startTime); 
								          $('#galleria').data('galleria').show(frame);
								        },
								        onEnd: function() {
								          //console.log("end");   
								       }
								    });
								}
						    }
						}					    
				    });
		         </script>
													
			    <script src="@routes.Assets.at("javascripts/galleria-1.2.9.js")" type="text/javascript"></script>
			    <script>
			    	$(function() {
					    // Load the classic theme
					    Galleria.loadTheme('@routes.Assets.at("javascripts/galleria-classic/galleria.classic.min.js")');
					
					    // Initialize Galleria
					    Galleria.run('#galleria');
					    
					    var gallery = $('#galleria').data('galleria');
					    
						Galleria.ready(function(options) {
						
						    // 'this' is the gallery instance
						    // 'options' is the gallery options
						
						    this.bind('image', function(e) {
						        Galleria.log('Now viewing ' + e.imageTarget.src);
						    });
						});
				      	 
				      	
				    });
			    </script>
    			}
    			@if(!f.metadata.isEmpty) {
					<div id='technicalMetadata_@(f.id.toString)'>
						<button class="tech_md_" type="button">Show file technical metadata</button>
						<div style="display:none;">
						<ul>
							@for(i <- 0 until f.metadata.length){								
								@printLevel(f.metadata(i).asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
							}
						</ul>
						</div>
					</div>
					<script>
						$("#technicalMetadata_@(f.id.toString) > button").on('click',function(){
							if($("#technicalMetadata_@(f.id.toString) > div").attr('style') == 'display:none;'){
								$("#technicalMetadata_@(f.id.toString) > div").attr('style', 'display:block;margin-left:80px;');
								$("#technicalMetadata_@(f.id.toString) > button").get(0).innerHTML = "Hide file technical metadata";
							}
							else{
								$("#technicalMetadata_@(f.id.toString) > div").attr('style', 'display:none;');
								$("#technicalMetadata_@(f.id.toString) > button").get(0).innerHTML = "Show file technical metadata";
							}
						});				
					</script>
				}
				@if(!f.xmlMetadata.isEmpty) {
					<div id='xmlMetadata_@(f.id.toString)'>
						<button class="tech_md_" type="button">Show XML-uploaded metadata</button>
						<div style="display:none;">
						<ul>								
								@printLevel(f.xmlMetadata)
						</ul>
						</div>
					</div>
					<script>
						$("#xmlMetadata_@(f.id.toString) > button").on('click',function(){
							if($("#xmlMetadata_@(f.id.toString) > div").attr('style') == 'display:none;'){
								$("#xmlMetadata_@(f.id.toString) > div").attr('style', 'display:block;');
								$("#xmlMetadata_@(f.id.toString) > button").get(0).innerHTML = "Hide file XML-uploaded metadata";
							}
							else{
								$("#xmlMetadata_@(f.id.toString) > div").attr('style', 'display:none;');
								$("#xmlMetadata_@(f.id.toString) > button").get(0).innerHTML = "Show file XML-uploaded metadata";
							}
						});	
					</script>
				}
				
				
					<div id='fileUserMetadata_@(f.id.toString)'>
							<button class="tech_md_" type="button">Show/edit file user-generated metadata</button>
							<div style="display:none;">
									@fileusermetadata(f, collection.mutable.Map() ++ f.userMetadata, rdfExported)						
							</div>
					</div>
					<script>
					$("#fileUserMetadata_@(f.id.toString) > button").on('click',function(){
						if($("#fileUserMetadata_@(f.id.toString) > div").attr('style') == 'display:none;'){
							$("#fileUserMetadata_@(f.id.toString) > div").attr('style', 'display:block;margin-left:80px;');
							$("#fileUserMetadata_@(f.id.toString) > button").get(0).innerHTML = "Hide file user-generated metadata";
						}
						else{
							$("#fileUserMetadata_@(f.id.toString) > div").attr('style', 'display:none;');
							$("#fileUserMetadata_@(f.id.toString) > button").get(0).innerHTML = "Show/edit file user-generated metadata";
						}
					});				
					</script>
				
												
    			
    				<hr class='file_separator'></hr>
    			
    			
    		}
    		}
    		<script>
    			$('.file_separator').last().remove();
    		</script>
    		@if(beingProcessed == true){
    			<div id='beingProcessed' style='display:block;'><h5>Dataset is being processed...</h5></div>  		
    		}else{
    			<div id='beingProcessed' style='display:none;'><h5>Dataset is being processed...</h5></div> 
    		}
    		<script>
    			function updateIsBeingProcessed(){
    				var request = $.ajax({
 				       type: 'GET',  
 				       url: "@api.routes.Datasets.isBeingProcessed(dataset.id)",
 				       contentType: "application/json"
 				     });
    				request.done(function (respJSON){
						if(respJSON.isBeingProcessed == "true")
							$("#beingProcessed").css('display','block');
						else
							$("#beingProcessed").css('display','none');
	     			});				 
				  request.fail(function (jqXHR, textStatus, errorThrown){
	     			});
    			}
    			$(function() {
    				setInterval("updateIsBeingProcessed();", 1000);
    			});
    		</script>
    		<script>
    			function addPreview(pv, fileId){
    				String.prototype.endsWith = function(str)
    				{
    				    var lastIndex = this.lastIndexOf(str);
    				    return (lastIndex != -1) && (lastIndex + str.length == this.length);
    				}
    				
    				var prevsOfFile = parseInt($("#filePrevContainer_" + fileId).attr('data-previewsCount'))
    				var newTabLink = document.createElement('a');
    				newTabLink.setAttribute('href', '#previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				$("#filePrevContainer_" + fileId).attr('data-previewsCount', '' + (prevsOfFile + 1));
    				newTabLink.setAttribute('data-toggle', 'tab');
    				newTabLink.innerHTML= pv.p_id;
    				var newListItem = document.createElement('li');
    				newListItem.appendChild(newTabLink);
    				$("#myTab_" + fileId).append(newListItem);
    				
    				var newPrevDiv = document.createElement('div');
    				newPrevDiv.setAttribute('class', 'tab-pane previewDiv');
    				newPrevDiv.setAttribute('id', 'previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				newPrevDiv.setAttribute('data-previewId', pv.pv_id);
    				newPrevDiv.setAttribute('data-previewerId', pv.p_id);
    				$("#previewsContent_" + fileId).append(newPrevDiv);
    				
    				//Previewer config vars
    				Configuration.tab = '#previewer_' + fileId +  '_' + (prevsOfFile + 1);
    				Configuration.url = pv.pv_route;
    				Configuration.fileid = pv.pv_id;
    				Configuration.previewer = pv.p_path;
    				if(pv.p_id === "Thumbnail"){
    					Configuration.fileType = pv.pv_contenttype;
    					Configuration.fileSize = pv.pv_length;			
    				}
    				else if(pv.p_id === "X3d"){							
    					Configuration.annotationsEditPath = pv.pv_annotationsEditPath;
    					Configuration.annotationsListPath = pv.pv_annotationsListPath;
    					Configuration.annotationsAttachPath = pv.pv_annotationsAttachPath;
    					Configuration.annotationsDeletePath = pv.pv_annotationsDeletePath;
    					Configuration.authenticatedIndividualResource = $("#filePrevContainer_" + fileId).attr('data-isAuthenticated') == 'true';
    					if($("#previewedFileName_" + fileId +" :nth-child(1)").text().endsWith(".ptm"))   					
    						Configuration.wasPTM = 'true';
    					else
    						Configuration.wasPTM = 'false';
    					Configuration.calledFrom = "dataset";
    				}
    				////
    				
    				var s = document.createElement("script");
    				s.type = "text/javascript";
    				s.src = pv.p_path + "/" + pv.p_main;
    				$("#previewsContent_" + fileId).append(s);
    				
    				if(prevsOfFile == 1){
    					$("#myTab_" + fileId).attr('style', 'display:block;');
    				}

    				else if(prevsOfFile == 0 && ($("#technicalMetadata_" + fileId).length == 0) && ($("#fileUserMetadata_" + fileId).length == 0)){   					
    					$("#filePrevContainer_" + fileId).before("<div id='previewedFileName_" + fileId + "' class='filenameDiv'><h4  style='font-weight:bold;'>" + $("#filePrevContainer_" + fileId).attr("data-filename")  + "</h4></div>");

    					var followingVisibleFiles = $("#filePrevContainer_" + fileId).nextAll(".filenameDiv");
    					if(followingVisibleFiles.length > 0){
    						followingVisibleFiles[0].before("<hr class='file_separator'></hr>");
    					}
    					else{
    						var previousVisibleFiles = $("#previewedFileName_" + fileId).prevAll(".filenameDiv");
    						if(previousVisibleFiles.length > 0){
    							$("#previewedFileName_" + fileId).before("<hr class='file_separator'></hr>");
        					}
    					}			
    				}
    				
    				
    				$('#myTab_' + fileId + ' a:first').tab('show');
    			}
    		
    			function checkForNewPreviews(){
	    			var request = $.ajax({
					       type: 'GET',  
					       url: "@api.routes.Datasets.getPreviews(dataset.id)",
					       contentType: "application/json"
					     });
					request.done(function (respJSON){
							//alert(JSON.stringify(respJSON));
						for(var i = 0; i < respJSON.length; i++){
							var pvs = respJSON[i].previews;
							for(var j = 0; j < pvs.length; j++){
								var pvId = pvs[j].pv_id;
								var pId = pvs[j].p_id;
								if($(".previewDiv[data-previewId='" + pvId + "'][data-previewerId='" + pId + "']").length == 0){
									addPreview(pvs[j], respJSON[i].file_id);
								}
							}
						}
						setTimeout("checkForNewPreviews();", 1000);
		     		});				 
					  request.fail(function (jqXHR, textStatus, errorThrown){
		        		setTimeout(function(){checkForNewPreviews()}, 1000);
		     			});
				}
    			$(function() {
    				setTimeout(function(){checkForNewPreviews()}, 1000);
    			});
    		</script>
    		<script>
    			function updateFiles(){
    				var request = $.ajax({
 				       type: 'GET',  
 				       url: "@api.routes.Datasets.datasetFilesList(dataset.id)",
 				       contentType: "application/json"
 				     });
    				request.done(function (respJSON){
    					for(var i = 0; i < respJSON.length; i++){
    						if($("#filePrevContainer_"+respJSON[i].id).length == 0){
    							var fileId = respJSON[i].id;
    							$("#bottomDatasetTabbable").before("<div class='row' style='position:relative;left:2%;' id='filePrevContainer_"+fileId+"' data-previewsCount='0' data-isAuthenticated='"+((@userIsAdmin) || ("@userOrAnon.identityId.userId") == respJSON[i].authorId)+"' data-filename='"+respJSON[i].filename+"'>"
    													+"<div class='span12'><div class='tabbable'><ul class='nav nav-pills' id='myTab_"+fileId+"'></ul>"
    													+"<div class='tab-content' id='previewsContent_"+fileId+"'></div></div></div></div>");
    							$('#myTab_'+fileId).attr('style', 'display:none;');
    							
    							var tableLength = $("#datasetFilesTable tbody tr").length;
    							var j = 1;
							        while(j <= tableLength && $("#datasetFilesTable tbody tr:nth-child("+j+") td:nth-child(1) a").text() < respJSON[i].filename){
							        	j++;
							        }

						        if(j <= tableLength)	    
							        $("#datasetFilesTable tbody tr:nth-child("+j+")").before("<tr><td class='file-list-cell'><a href='"+  window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/files/"+fileId+"'>"+respJSON[i].filename+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='detachFile(\""+fileId+"\",\""+respJSON[i].filename+"\",event)'>Detach</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' title='Delete File' onclick='removeFile(\""+fileId+"\",event,true)'><span class=\"glyphicon glyphicon-trash\"></span></a></td></tr>"
							        		);
						        else if(tableLength > 0)
						        	$("#datasetFilesTable tbody tr:nth-child("+(j-1)+")").after("<tr><td class='file-list-cell'><a href='"+  window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/files/"+fileId+"'>"+respJSON[i].filename+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='detachFile(\""+fileId+"\",\""+respJSON[i].filename+"\",event)'>Detach</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' title='Delete File' onclick='removeFile(\""+fileId+"\",event,true)'><span class=\"glyphicon glyphicon-trash\"></span></a></td></tr>"
							        		);
						        else{
						        	if($("#datasetFilesTable tbody").length == 0)
						        		$("#datasetFilesTable").append("<tbody></tbody>");
						        	$("#datasetFilesTable tbody").append("<tr><td class='file-list-cell'><a href='"+  window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/files/"+fileId+"'>"+respJSON[i].filename+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='detachFile(\""+fileId+"\",\""+respJSON[i].filename+"\",event)'>Detach</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' title='Delete File' onclick='removeFile(\""+fileId+"\",event,true)'><span class=\"glyphicon glyphicon-trash\"></span></a></td></tr>"
							        		);
						        	}
    						}
    					}
    					setTimeout(function(){updateFiles()}, 2000);
	     			});				 
				  request.fail(function (jqXHR, textStatus, errorThrown){
	        		setTimeout(function(){updateFiles()}, 2000);
	     			});
    			}
    			$(function() {
    				setTimeout(function(){updateFiles()}, 2000);
    			});
    		</script>    		
    		
    		
	    	<div class="tabbable" id="bottomDatasetTabbable"> <!-- Only required for left/right tabs -->
			  <ul class="nav nav-tabs">
			    <li class="active"><a href="#tab1" data-toggle="tab">Comments</a></li>
			    <li><a href="#tab2" data-toggle="tab">Metadata</a></li>
			    <li><a href="#tab3" data-toggle="tab">Notes</a></li>
			  </ul>
			  <div class="tab-content">
			    <div class="tab-pane active" id="tab1">
				      @if(user.isDefined) {
				      	  @commentform(dataset.id.stringify, api.routes.Datasets.comment(dataset.id).toString)
				      }
			 		  <div class="comment-threads unstyled" id="reply_@dataset.id.toString">
				      	 @comment(comments)
				      </div> 
			    </div>
			    <div class="tab-pane" id="tab2">
			      @metadata(dataset, md, usrmd, dataset.datasetXmlMetadata, rdfExported)
			    </div>
			    <div class="tab-pane" id="tab3">
			      @notesform(dataset.id.toString, api.routes.Datasets.setNotesHTML(dataset.id).toString, dataset.notesHTML.getOrElse(""))
			    </div>
			  </div>
			</div>	
			    		
		</div>
		

		<!-- right column -->
		<div class="col-md-4">
		
		  <!-- Dataset information elements --> 
          <div id="aboutDiv" class="row ds-section-sm" style="margin-top:20px; width: 370px; padding-left:15px;">        
            <div class="accordion" id="accordion5" style="width: 370px;">
                <div class="accordion-group">
                    <h4>About</h4>
                    <div class="accordian-heading" style="padding-left:20px;">                        
                        <table>
                           <tr>
                            <td><b>Owner: </b></td>
                            <td id="aboutowner" style="padding-left:10px;">@dataset.author.fullName</td>
                           </tr>
                           <tr>
                            <td style="vertical-align:top;"><b>Description: </b></td>
                            <td id="aboutdesc" style="padding-left:10px;">@dataset.description</td>
                           </tr>
                           <tr>
                            <td><b>Created: </b></td>
                            <td id="aboutcreate" style="padding-left:10px;">@dataset.created.format("MMM dd, yyyy")</td>
                           </tr>
                        </table>
                        <p>
                         @if(user.isDefined) {
                            <a class="btn btn-info btn-large accordion-toggle collapsed" data-toggle="collapse"
                               data-parent="#accordion7" href="#collapseSeven" id="editabout" style="padding-left:2px;"
                               title="Edit Dataset Information"><span class="glyphicon glyphicon-chevron-down"></span> Edit</a>
                         }
                    </div>
                    <div id="collapseSeven" class="accordion-body collapse" style="padding:5px 10px 5px 10px;">
                    <div class="panel panel-info">
                        <div class="panel-body">
                        @if(user.isDefined) {
                            <form class="form-inline" id="form2">
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="width: 30%; vertical-align:top;">Name:</td>
                                        <td>
                                            <textarea cols=30 rows=4 type="text" id="editname">@dataset.name</textarea>                                            
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width: 30%; vertical-align:top;">Description:</td>
                                        <td>
                                            <textarea cols=30 rows=4 type="text" id="editdesc">@dataset.description</textarea>                                            
                                        </td>
                                    </tr>
                                </table>
                                <br>
                                
                                <button class="btn btn-primary" onclick="return updateAboutData('@dataset.id.stringify');" title="Update Information"><span class="glyphicon glyphicon-edit"></span> Submit</button>
                                <button class="btn btn-default" onclick="return closeAboutEdit();" title="Close Editor"><span class="glyphicon glyphicon-chevron-up"></span> Close</button>
                             </form>
                        }
                        </div>
                    </div>
                    </div>
                </div>
            </div>
          </div>
          
          <script type="text/javascript" language="javascript">
              function closeAboutEdit() {
            	  //Reset the data to the current values
            	  var text = $("#aboutdesc").text();
            	  $("#editdesc").val(text);
            	  text = $("#aboutname").text();
            	  $("#editname").val(text);
            	  
            	  //Close the edit form
                  $("#editabout").addClass('collapsed');
                  $("#collapseSeven").collapse('toggle');      
                  return false;
              }
              
              function updateAboutData(datasetId) {            	  
            	  var description = $("#editdesc").val();
            	  var name = $("#editname").val();            	  
            	  var encName = htmlEncode(name);
            	  var encDescription = htmlEncode(description);
            	  var jsonData = JSON.stringify({"description":encDescription, "name":encName});                 
                  
                  var request = jsRoutes.api.Datasets.updateInformation(datasetId).ajax({
                	  data: jsonData,
                      type: 'POST',
                      contentType: "application/json",
                  });
                  
                  request.done(function (response, textStatus, jqXHR){
                      ///console.log("Response " + response);
                      //Sucessful update of the DB - update the interface

                      $("#aboutdesc").text(htmlDecode(encDescription));
                      $("#aboutname").text(htmlDecode(encName));
                      
                      closeAboutEdit();
                   });
          
                   
                   request.fail(function (jqXHR, textStatus, errorThrown){
                	   console.error("The following error occured: "+textStatus, errorThrown);
                       var errMsg = "You must be logged in to update the information about a dataset.";
                           alert("The dataset information was not updated due to : " + errorThrown);
                   });
                  
            	  return false;
              }                            
          </script>
          
          <script src="@routes.Assets.at("javascripts/htmlEncodeDecode.js")" language="javascript"></script>
          <!-- End dataset information elements -->          
			 

			<div class="row ds-section-sm">
				<h4>Files</h4>
				<table id="datasetFilesTable">
				@dataset.files.map { file =>				
					<tr><td  class="file-list-cell"><a href="@(routes.Files.file(file.id))" title="@file.contentType">@file.filename</a>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td><a href="#" class="requiresLogin" style="font-style:italic;" onclick="detachFile('@(file.id)','@(file.filename)',event)">Detach</a>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td><a class="requiresLogin btn btn-link" href="#" title="Delete File" onclick="removeFile('@(file.id)',event,true);">
					    <span class="glyphicon glyphicon-trash"></span>
					</a></td></tr>
				}
				</table>
				<script src="@routes.Assets.at("javascripts/fileListProcess.js")" type="text/javascript"></script>
				<a href="#myModal" class="btn btn-info active requiresLogin" data-toggle="modal" id="fileUploadBtn" title="Add New File to Dataset" role="button">
				    <span class="glyphicon glyphicon-export"></span> Add
				</a>
				<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				    <div class="modal-dialog">
				      <div class="modal-content">
				      @form(action = routes.Files.uploaddnd(dataset.id), 'enctype -> "multipart/form-data", 'role -> "form") {
				        <div class="modal-header">
				          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				          <h4 class="modal-title">Upload File</h4>
				        </div>
				        <div class="modal-body">
				 		  <div class="form-group">
						    <label for="exampleInputFile">New File</label>
						    <input type="file" id="query" name="File">
						    <p class="help-block">The file will be uploaded and added to this dataset.</p>
								    	Show file preview(s)
		          						<br/>				
		          						<input type="radio" name="datasetLevel" value="DatasetLevel" checked> Everywhere<br>
										<input type="radio" name="datasetLevel" value="FileLevel"> On file page<br>
										<input type="radio" name="datasetLevel" value="None"> Nowhere
						  </div>
				        </div>
				        <div class="modal-footer">
				          <button type="submit" class="btn btn-primary" title="Upload File"><span class="glyphicon glyphicon-open"> Upload</span></button>				          
				        </div>
				      }
				      </div><!-- /.modal-content -->
				    </div><!-- /.modal-dialog -->
				  </div><!-- /.modal -->
				</div>
								
				<div class="ui-widget requiresLogin" id="filesUi" style="padding-top:15px;">                 
					<select id="filesAddSelect" data-inputid="selectingInputFiles" data-errorid="doesNotExistErrorFiles">
					<option value="" selected="selected"></option>					  
					@filesOutside.map { file =>  
						<option value="@(file.id)">@(file.filename)</option>
					}					  
					</select>					
					<button class="btn btn-primary btn-small" id="addFileBtn" style="vertical-align:center;" title="Add Existing File">
					   <span class="glyphicon glyphicon-plus"></span>
					</button>
					<span style="color:red;display:none;margin-top:10px;font-size:14px;font-family:Helvetica Neue,Helvetica,Arial,sans-serif" id="doesNotExistErrorFiles" >File does not exist or already added.</span>
				</div>
					<script src="@routes.Assets.at("javascripts/book.js")" type="text/javascript"></script>	
					<script src="@routes.Assets.at("javascripts/combobox.js")" type="text/javascript"></script>
					<script>
						$("#filesAddSelect").combobox();
					</script>
					<script>
						$('body').on('click','#addFileBtn',function(e){
							if($("#doesNotExistErrorFiles").css('display') == 'inline')
								return;
							if($("#selectingInputFiles").val() == ""){
								$("#doesNotExistErrorFiles").css('display','inline');
								return;
							}
							
							var selectedId = $("#filesAddSelect").val();
							var selectedName = $("#filesAddSelect option:selected").text();
							var request = $.ajax({
							       type: 'POST',
							       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/datasets/"+"@dataset.id"+"/files/"+selectedId
							     });  
							request.done(function (response, textStatus, jqXHR){
						        console.log("Response " + response);	        
						        $("#filesAddSelect option[value=" + selectedId + "]").remove();
						        $("#selectingInputFiles").val("");
						        var i = 1;
						        
							});	
							request.fail(function (jqXHR, textStatus, errorThrown){
						    		console.error(
						        		"The following error occured: "+
						        		textStatus, errorThrown		            
						    			);
						    		alert("ERROR: " + errorThrown +". File not added to dataset. The dataset or file was possibly removed." );
					 			});				
						});
						
						function detachFile(fileId, fileName,event){
							var request = $.ajax({
							       type: 'POST',
							       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/datasets/"+"@dataset.id"+"/filesRemove/"+fileId+"/True"
							     });
							request.done(function (response, textStatus, jqXHR){
								console.log("Response " + response);	        
								$(event.target.parentNode.parentNode).remove();
								var i = 1;
						        var selectLength = $("#filesAddSelect option").length;
						        while(i <= selectLength && $("#filesAddSelect option:nth-child("+i+")").text() < fileName)
						        	i++;
						        if(i <= selectLength)
						        	$("#filesAddSelect option:nth-child("+i+")").before("<option value='"+fileId+"'>"+fileName+"</option>");
						        else if(selectLength > 0)
						        	$("#filesAddSelect option:nth-child("+(i-1)+")").after("<option value='"+fileId+"'>"+fileName+"</option>");
						        else
						        	$("#filesAddSelect").append("<option value='"+fileId+"'>"+fileName+"</option>");
						        
						        $("#filesAddSelect").combobox();
							        var nextHRs = $("#previewedFileName_"+fileId).nextAll("hr");
							        if(nextHRs.length > 0){
							        	nextHRs.first().remove();
							        }
							        else{
							        	var prevHRs = $("#previewedFileName_"+fileId).prevAll("hr");
							        	if(prevHRs.length > 0){
							        		prevHRs.first().remove();
								        }
							        }						        
						        $("#previewedFileName_"+fileId).remove();
						        $("#filePrevContainer_"+fileId).remove();
						        $("#technicalMetadata_"+fileId).remove();						        						        
						        $("#fileUserMetadata_"+fileId).remove();						        
							});	
							request.fail(function (jqXHR, textStatus, errorThrown){
						    		console.error(
						        		"The following error occured: "+
						        		textStatus, errorThrown		            
						    			);
						    		alert("ERROR: " + errorThrown +". File not detached from dataset." );
					 			});
						}
						
					</script>
	
			<div class="row ds-section-sm">
				<h4>Collections</h4>
				<table id="collTable">
				@collectionsInside.map { collection =>
					<tr><td><a href="@(routes.Collections.collection(collection.id))">@collection.name</a>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td class="requiresLogin requiresLoginCommunity">
						@if(userIsAdmin){
									<a href="#" style="font-style:italic;" onclick="removeCollection('@(collection.id)','@(collection.name)',event)">Remove</a>
						}
						@if(user.isDefined && !userIsAdmin) {
									@if(!collection.author.isDefined){
										<a href="#" style="font-style:italic;" onclick="removeCollection('@(collection.id)','@(collection.name)',event)">Remove</a>
									}
									@if(collection.author.isDefined){
										@if(user.get.identityId.userId.equals(collection.author.get.identityId.userId)){
											<a href="#" style="font-style:italic;" onclick="removeCollection('@(collection.id)','@(collection.name)',event)">Remove</a>
										}
									}					
						}
					</td>
					</tr>
				}
				</table>

				<div class="requiresLogin ui-widget requiresLoginCommunity" id="collectionsUi">			

						<div class="input-group input-group-sm col-md-8"">
							<select id="collectionAddSelect"  data-inputid="selectingInputCollections" data-errorid="doesNotExistErrorCollections" style="vertical-align:center;">
							@collectionsOutside.map { collection =>
								@if(userIsAdmin){
									<option value="@(collection.id)">@(collection.name)</option>
								}
								@if(user.isDefined && !userIsAdmin) {
									@if(!collection.author.isDefined){
										<option value="@(collection.id)">@(collection.name)</option>
									}
									@if(collection.author.isDefined){
										@if(user.get.identityId.userId.equals(collection.author.get.identityId.userId)){
											<option value="@(collection.id)">@(collection.name)</option>
										}
									}					
								}								
							}					  
							</select>
							<span class="input-group-btn">
								<button class="btn btn-primary btn-large" id="addCollBtn" title="Add Dataset To Collection" style="vertical-align:center;">
                                    <span class="glyphicon glyphicon-plus"></span>
                                </button>
							</span>
						</div>
						<span style="color:red;display:none;margin-top:10px;font-size:14px;font-family:Helvetica Neue,Helvetica,Arial,sans-serif"  id="doesNotExistErrorCollections">Collection does not exist or already added.</span>

				</div>
					<script src="@routes.Assets.at("javascripts/combobox.js")" type="text/javascript"></script>
					<script type="text/javascript">
						$("#collectionAddSelect").combobox();
						//$("#collectionAddSelect").css("display", "inline");
						
	  					function selectClickChange() {
	  						var theSelectedColl = document.getElementById("collectionAddSelect");
	  						document.getElementById("selectCollectionInput").value = theSelectedColl.options[theSelectedColl.selectedIndex].text;
	  					}
	  					document.getElementById("collectionAddSelect").onchange = selectClickChange;
					</script>
					<script>
						$('body').on('click','#addCollBtn',function(e){
							if($("#doesNotExistErrorCollections").css('display') == 'inline')
								return;
							if($("#selectingInputCollections").val() == ""){
								$("#doesNotExistErrorCollections").css('display','inline');
								return;
							}
							
							var selectedId = $("#collectionAddSelect").val();
							var selectedName = $("#collectionAddSelect option:selected").text();
							var request = $.ajax({
							       type: 'POST',
							       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/collections/"+selectedId+"/datasets/"+"@dataset.id"
							     });  
							request.done(function (response, textStatus, jqXHR){
						        console.log("Response " + response);	        
						        $("#collectionAddSelect option[value=" + selectedId + "]").remove();
						        $("#selectingInputCollections").val("");
						        var i = 1;
						        var tableLength = $("#collTable tbody tr").length;
						        while(i <= tableLength && $("#collTable tbody tr:nth-child("+i+") td:nth-child(1) a").text() < selectedName)
						        	i++;
						        if(i <= tableLength)	        
							        $("#collTable tbody tr:nth-child("+i+")").before("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/collection/"+selectedId+"'>"+selectedName+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeCollection(\""+selectedId+"\",\""+selectedName+"\",event)'>Remove</a></td></tr>"
							        		);
						        else if(tableLength > 0)
						        	$("#collTable tbody tr:nth-child("+(i-1)+")").after("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/collection/"+selectedId+"'>"+selectedName+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeCollection(\""+selectedId+"\",\""+selectedName+"\",event)'>Remove</a></td></tr>"
							        		);
						        else{
						        	if($("#collTable tbody").length == 0)
						        		$("#collTable").append("<tbody></tbody>");
						        	$("#collTable tbody").append("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/collection/"+selectedId+"'>"+selectedName+"</a>"
							        		+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeCollection(\""+selectedId+"\",\""+selectedName+"\",event)'>Remove</a></td></tr>"
							        		);
						        	}
							});	
							request.fail(function (jqXHR, textStatus, errorThrown){
								console.error("The following error occured: " + textStatus, errorThrown);
                                var errMsg = "You must be logged in to add a dataset to a collection.";                                
                                    alert("The dataset was not added to the collection due to the following : " + errorThrown);
					 		});				
						});
						
						function removeCollection(collectionId, collectionName,event){
							var request = $.ajax({
							       type: 'POST',
							       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/collections/"+collectionId+"/datasetsRemove/"+"@dataset.id"+"/True"
							     });
							request.done(function (response, textStatus, jqXHR){
								console.log("Response " + response);	        
								$(event.target.parentNode.parentNode).remove();
								var i = 1;
						        var selectLength = $("#collectionAddSelect option").length;
						        while(i <= selectLength && $("#collectionAddSelect option:nth-child("+i+")").text() < collectionName)
						        	i++;
						        if(i <= selectLength)
						        	$("#collectionAddSelect option:nth-child("+i+")").before("<option value='"+collectionId+"'>"+collectionName+"</option>");
						        else if(selectLength > 0)
						        	$("#collectionAddSelect option:nth-child("+(i-1)+")").after("<option value='"+collectionId+"'>"+collectionName+"</option>");
						        else
						        	$("#collectionAddSelect").append("<option value='"+collectionId+"'>"+collectionName+"</option>");
						        
						        $("#collectionAddSelect").combobox();
							});	
							request.fail(function (jqXHR, textStatus, errorThrown){
								console.error("The following error occured: " + textStatus, errorThrown);
                                var errMsg = "You must be logged in to remove a dataset from a collection.";                                
                                    alert("The dataset was not removed from the collection due to : " + errorThrown);
					 		});
						}
						
					</script>
			</div>
			
			<div class="row ds-section-sm">
				<h4>Tags</h4>
				<ul id="tagList">
					@dataset.tags.map { tag =>
					  <li name='@tag.name'>
					  	<a href="@routes.Tags.search(tag.name)">@tag.name [Dataset]</a>
					  	<a href="javascript:void(0);"><span id="@tag.name" class="glyphicon glyphicon-remove" style="display:none;"></span></a>
					  </li>
					}
  				    @dataset.files.map { file =>
						@file.tags.map { tag =>
						  <li>
                              <a href="@routes.Tags.search(tag.name)">@tag.name [File]</a>
                          </li>
						}
				    	@file.sections.map { section =>
							@section.tags.map { tag =>
							  <li>
                                  <a href="@routes.Tags.search(tag.name)">@tag.name [Section]</a>
                              </li>
							}
						}
				   }
				</ul>
				<form class="form-inline requiresLogin requiresLoginCommunity">
					<div class="input-group input-group-sm col-md-8"">
						<input type="text" id="tagField" class="form-control">
						<span class="input-group-btn">
							<button class="btn btn-primary btn-large" id="tagB" title="Add Tag">
							    <span class="glyphicon glyphicon-tag"></span>
							</button>
						</span>
					</div>
				</form>
				<script language="javascript">
			     		window["userDefined"] = false;
			       </script>
				@if(user.isDefined) {
		      	   <script language="javascript">
			     		window["userDefined"] = true;
			       </script>
		      	}
				<script language="javascript">
					function removeTag(){
                        var tagId = $(this).attr("id");
                        console.log("Removing tag " + tagId);

                        var request = jsRoutes.api.Datasets.removeTags('@dataset.id').ajax({
                            data: JSON.stringify({"tags":[tagId]}),
                            type: 'POST',
                            contentType: "application/json"
                        });

                        request.done(function (response, textStatus, jqXHR){
                            console.log("Response " + textStatus);
                            $("#" + tagId).parents("li").remove();
                        });

                        request.fail(function (jqXHR, textStatus, errorThrown){
                        	console.error("The following error occured: " + textStatus, errorThrown);
                            var errMsg = "You must be logged in to remove a tag from a dataset.";                                
                            
                                alert("The tag was not removed from the dataset due to : " + errorThrown);
                                 
                        });

                        return false;
                    }
				
					function removeIconMouseIn() {
				   		$(this).find(".glyphicon-remove").fadeIn(100);
					}

					function removeIconMouseOut() {
				   		$(this).find(".glyphicon-remove").fadeOut(100);				   	
					}

					$(function() {
                       if(window["userDefined"] == true)
                         $("#tagList").children("li").each(function(){
                           $(this).hover(removeIconMouseIn,removeIconMouseOut);
                         });
                       $("#tagList").find(".glyphicon-remove").click(removeTag);
						
					   $('#tagB').click(function() {
					     var tag = $('#tagField').val();
					     
					     var isTagPresent = false;
					     $("#tagList").children("li").each(function (index, tagLi) {
					       if($(tagLi).attr("name")===tag){
					         isTagPresent = true;
					         alert(true);
					       }
					     });
	
					     if (tag !== "" && isTagPresent != true) {
					     	 console.log("submitting tag " + tag);
					     	var request = jsRoutes.api.Datasets.addTags('@dataset.id').ajax({
					     		data: JSON.stringify({"tags":[tag]}),
						       type: 'POST',
						       contentType: "application/json",
						     });
						     
						     request.done(function (response, textStatus, jqXHR){
						        console.log("Response " + response);
						        var url = "../tags/search?tag=" + tag;
						        $newTag = $("<li><a href='" + url + "'>" + tag + " [Dataset]</a><a href='javascript:void(0);'><i style='display:none;'id='" + tag +"' class='glyphicon glyphicon-remove'></i></a></li>").appendTo('#tagList');
						        $newTag.hover(removeIconMouseIn,removeIconMouseOut);
     						    $newTag.find(".glyphicon-remove").click(removeTag);
						        $('#tagField').val("");
						     });
				    
						     request.fail(function (jqXHR, textStatus, errorThrown){
						        console.error("The following error occured: "+textStatus, errorThrown);
						        var errMsg = "You must be logged in to add a tag to a dataset.";
                                    alert("The tag was not added to the dataset due to : " + errorThrown);
                                 
						     });
						     return false;
					     }
					     
					  });
					  
					  	$('#tagField').keypress(function (e) {
						  if (e.which == 13) {
						    console.log("enter");
						    $('#tagB').click();
						    return false;
						  }
						});
				  
				 });
			     </script>			     
			     @if(!user.isDefined) {
		      	   <script language="javascript">
			     		$(".requiresLogin").css("display","none");
			       </script>
		      	 }
		      	 @if(user.isDefined && !userIsAdmin) {
		      	 	@if(!user.get.identityId.userId.equals(dataset.author.identityId.userId)){
			      	   <script language="javascript">
				     		$(".requiresLogin:not(.requiresLoginCommunity)").css("display","none");
				       </script>
			       }
		      	 }
			</div>
			     <!-- License elements --> 
          <div id="accordionsDiv" class="row ds-section-sm" style="margin-top:20px; width: 370px; padding-left:15px;">        
	        <div class="accordion" id="accordion6" style="width: 370px; padding:5px 10px 5px 10px;">
	            <div class="accordion-group">
	                <div class="accordian-heading">
	                    <h4>License Information</h4>
	                    <table>
	                       <tr>
	                        <td><b>License Holder: </b></td>
	                        <td id="rightsholderdata" style="padding-left:10px;">blank</td>
	                       </tr>
	                       <tr>
	                        <td><b>License Text: </b></td>
	                        <td id="licensetextdata" style="padding-left:10px;">blank</td>
	                       </tr>
	                    </table>
	                    <p>
	                    @if(user.isDefined) {
	                    <a class="btn btn-info accordion-toggle collapsed" data-toggle="collapse"
	                        data-parent="#accordion6" href="#collapseSix" id="editlicense"
	                        title="Edit License Information">
	                        <span class="glyphicon glyphicon-chevron-down"></span> Edit
	                    </a>
	                    }
	                </div>
	                <div id="collapseSix" class="accordion-body collapse">
	                   <div class="panel panel-info">
                           <div class="panel-body">
	                    @if(user.isDefined) {
	                        @licenseform(dataset.id.stringify, dataset.licenseData, "dataset", dataset.author.fullName)
	                    }
	                       </div>
	                   </div>
	                </div>
	            </div>
	        </div>
	      </div>
	      
        <script type="text/javascript" language="javascript">
        $(document).ready(function() {                 	
            //Will have to modify the if check to see if there is data that specifies what should be selected
            //Incoming data may specifiy the type of license, the name of the owner of the rights, the text
            //describing the license rights, the URL for the license, and whether or not downloading is 
            //allowed.        
            var datasetLicenseType = "@dataset.licenseData.m_licenseType";
            var datasetRightsHolder = "@dataset.licenseData.m_rightsHolder";
            var datasetLicenseText = "@dataset.licenseData.m_licenseText";
            var datasetLicenseUrl = "@dataset.licenseData.m_licenseUrl";        
            var datasetAllowDownload = "@dataset.licenseData.m_allowDownload";    
            var datasetImageBase = '@routes.Assets.at("images")';
            var datasetAuthorName = '@dataset.author.fullName';
            
            if (!@user.isDefined){
                updateInterface(datasetLicenseType, datasetRightsHolder, datasetLicenseText, datasetLicenseUrl, datasetAllowDownload, datasetImageBase, datasetAuthorName);
            }
        });
        </script>
        <!-- End License elements -->
		</div>
	</div>	
}
}	
}
